<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Carlos Controller</title>

    <link rel="stylesheet" href="https://unpkg.com/axist@latest/dist/axist.min.css"/>
    <style>
        .video-size {
            width: 80%;
            aspect-ratio: 4 / 3;
            display: block;
            margin: 0 auto;
            transform: rotate(180deg);
        }

        .flex-center {
            display: flex;
            justify-content: center;
        }

        .box {
            display: flex;
            align-items: stretch;
        }

        .item {
            padding: 1em;
        }
    </style>
</head>
<body>
    <video class="video-size" id="stream" autoplay playsinline>Your browser does not support video</video>
    <br>
    <div class="flex-center">
        <a href="javascript:setChannel(-1)" id="left">&#8592;</a>
        <p>Current channel:&nbsp;</p>
        <p id="video-channel">0</p>
        <a href="javascript:setChannel(1)" id="right">&#8594;</a>
    </div>

    <p>Use wasd for control</p>
    <div class="box">
        <div class="item">
            <label for="speed">Speed of Carlos(10-100):</label>
            <input type="number" id="speed" step="10" onchange="speedUpdate(this.value)" name="speed" value="100"
                   min="10"
                   max="100">
        </div>

        <div class = "item">
            <label for="channel">Select channel:</label>
            <input type="number" id="channel" step="1" onchange="channelUpdate(this.value)" name="channel" value="0"
                   min="0"
                   max="5">
        </div>
    </div>

     <script type="text/javascript" src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
     <script type="text/javascript">
       var html5VideoElement;
       var websocketConnection;
       var webrtcPeerConnection;
       var webrtcConfiguration;
       var reportError;


       function onLocalDescription(desc) {
         console.log("Local description: " + JSON.stringify(desc));
         webrtcPeerConnection.setLocalDescription(desc).then(function() {
           websocketConnection.send(JSON.stringify({ type: "sdp", "data": webrtcPeerConnection.localDescription }));
         }).catch(reportError);
       }


       function onIncomingSDP(sdp) {
         console.log("Incoming SDP: " + JSON.stringify(sdp));
         webrtcPeerConnection.setRemoteDescription(sdp).catch(reportError);
         webrtcPeerConnection.createAnswer().then(onLocalDescription).catch(reportError);
       }


       function onIncomingICE(ice) {
         var candidate = new RTCIceCandidate(ice);
         console.log("Incoming ICE: " + JSON.stringify(ice));
         webrtcPeerConnection.addIceCandidate(candidate).catch(reportError);
       }


       function onAddRemoteStream(event) {
         html5VideoElement.srcObject = event.streams[0];
       }


       function onIceCandidate(event) {
         if (event.candidate == null)
           return;

         console.log("Sending ICE candidate out: " + JSON.stringify(event.candidate));
         websocketConnection.send(JSON.stringify({ "type": "ice", "data": event.candidate }));
       }


       function onServerMessage(event) {
         var msg;

         try {
           msg = JSON.parse(event.data);
         } catch (e) {
           return;
         }

         if (!webrtcPeerConnection) {
           webrtcPeerConnection = new RTCPeerConnection(webrtcConfiguration);
           webrtcPeerConnection.ontrack = onAddRemoteStream;
           webrtcPeerConnection.onicecandidate = onIceCandidate;
         }

         switch (msg.type) {
           case "sdp": onIncomingSDP(msg.data); break;
           case "ice": onIncomingICE(msg.data); break;
           default: break;
         }
       }


       function playStream(videoElement, hostname, port, path, configuration, reportErrorCB) {
         var l = window.location;
         var wsHost = (hostname !== undefined) ? hostname : l.hostname;
         var wsPort = (port !== undefined) ? port : l.port;
         var wsPath = (path !== undefined) ? path : "ws";
         if (wsPort)
          wsPort = ":" + wsPort;
        var wsUrl = "ws://" + wsHost + wsPort + "/" + wsPath;

         html5VideoElement = videoElement;
         webrtcConfiguration = configuration;
         reportError = (reportErrorCB !== undefined) ? reportErrorCB : function(text) {};

         websocketConnection = new WebSocket(wsUrl);
         websocketConnection.addEventListener("message", onServerMessage);
       }

       window.onload = function() {
         let vidstream = document.getElementById("stream");
         let config = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] };
        playStream(vidstream, "localhost", 57770, 'ws', config, function (errmsg) { console.error(errmsg); });
       };


       function setChannel(channel) {
           const maxChannel = 10;
           let next_channel = parseInt(document.getElementById("video-channel").innerText) + channel;
           next_channel = Math.min(maxChannel, next_channel);
           next_channel = Math.max(0, next_channel);

           document.getElementById("video-channel").innerText = next_channel.toString();

           html5VideoElement.srcObject.getTracks().forEach(track => track.stop());
           webrtcPeerConnection.close();
           let port = 57770 + next_channel;

           let vidstream = document.getElementById("stream");
           let config = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] };
           playStream(vidstream, "localhost", port, 'ws', config, function (errmsg) { console.error(errmsg); });
       }
     </script>

    <script>
        let websocket;

        const keys = ['w', 'a', 's', 'd'];
        const pressedKeys = new Set();

        function connect() {
            websocket = new WebSocket("ws://localhost:8888");
            websocket.onopen = function (event) {
                console.log(event);
                checkPressedKeys();
                speedUpdate(document.getElementById("speed").value);
                channelUpdate(document.getElementById("channel").value);
            };

            websocket.onclose = function (event) {
                console.log("Socket closed. Attempt reconnect.", event.reason);
                setTimeout(function () {
                    connect();
                }, 1000);
            };

            websocket.onerror = function (err) {
                console.error("Websocket error", err);
                websocket.close();
            }

            document.addEventListener('keydown', function (event) {
                keys.forEach(function (key) {
                        if (key === event.key) {
                            pressedKeys.add(key);
                        }
                    }
                )
                checkPressedKeys();
            });

            document.addEventListener('keyup', function (event) {
                keys.forEach(function (key) {
                        if (key === event.key) {
                            pressedKeys.delete(key);
                        }
                    }
                )
                checkPressedKeys();
            });

        }


        function speedUpdate(speed) {
            const event = {type: "speed", speed: parseInt(speed)};
            websocket.send(JSON.stringify(event));
        }

        function channelUpdate(channel) {
            const event = {type: "channel", channel: parseInt(channel)};
            websocket.send(JSON.stringify(event));
        }

        function checkPressedKeys() {
            const [key] = pressedKeys;
            if (key) {
                sendKey(key);
            } else {
                sendKey('no_key');
            }
        }

        function sendKey(key) {
            const event = {type: "keyPress", key: key};
            websocket.send(JSON.stringify(event));
        }

        connect();

    </script>
</body>
</html>
