<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Carlos Controller</title>

    <link rel="stylesheet" href="https://unpkg.com/axist@latest/dist/axist.min.css"/>
    <style>
        .video-size {
            width: 80%;
            aspect-ratio: 4 / 3;
            display: block;
            margin: 0 auto;
            transform: rotate(180deg);
        }

        .flex-center {
            display: flex;
            justify-content: center;
        }

        .box {
            display: flex;
            align-items: stretch;
        }

        .item {
            padding: 1em;
        }
    </style>
</head>
<body>
    <video id="videoPlayer" class="video-size" autoplay muted playsinline></video>
    <br>
    <div class="flex-center">
        <a href="javascript:setChannel(-1)" id="left">&#8592;</a>
        <p>Current channel:&nbsp;</p>
        <p id="video-channel">0</p>
        <a href="javascript:setChannel(1)" id="right">&#8594;</a>
    </div>

    <p>Use wasd for control</p>
    <div class="box">
        <div class="item">
            <label for="speed">Speed of Carlos(10-100):</label>
            <input type="number" id="speed" step="10" onchange="speedUpdate(this.value)" name="speed" value="100"
                   min="10"
                   max="100">
        </div>

        <div class = "item">
            <label for="channel">Select channel:</label>
            <input type="number" id="channel" step="1" onchange="channelUpdate(this.value)" name="channel" value="0"
                   min="0"
                   max="5">
        </div>
    </div>
    <script>
        let webrtc, webrtcSendChannel;
        let mediaStream;

        document.addEventListener("DOMContentLoaded", function () {
            startPlay();
        });

        async function startPlay() {
            mediaStream = new MediaStream();
            document.querySelector('#videoPlayer').srcObject = mediaStream;
            webrtc = new RTCPeerConnection({
                iceServers: [{
                    urls: ["stun:stun.l.google.com:19302"]
                }],
                sdpSemantics: "unified-plan"
            });
            webrtc.onnegotiationneeded = handleNegotiationNeeded;
            webrtc.onsignalingstatechange = signalingstatechange;

            webrtc.ontrack = ontrack
            let offer = await webrtc.createOffer({

                offerToReceiveAudio: true,
                offerToReceiveVideo: true
            });
            await webrtc.setLocalDescription(offer);
        }

        function ontrack(event) {
            mediaStream.addTrack(event.track);
        }

        function setChannel(channel) {
            const maxChannel = 10;
            let next_channel = parseInt(document.getElementById("video-channel").innerText) + channel;
            next_channel = Math.min(maxChannel, next_channel);
            next_channel = Math.max(0, next_channel);

            document.getElementById("video-channel").innerText = next_channel.toString();

            mediaStream.getTracks().forEach(track => track.stop());
            webrtc.close();
            startPlay();
        }

        async function signalingstatechange() {
            switch (webrtc.signalingState) {
                case 'have-local-offer':
                    const schema = 'http'
                    const server = 'localhost'
                    const port = '8083'
                    const uuid = '27aec28e-6181-4753-9acd-0456a75f0289'

                    let channel = parseInt(document.getElementById("video-channel").innerText);


                    let url = schema + '://' + server + ':' + port + '/stream/' + uuid + '/channel/' + channel + '/webrtc?uuid=' + uuid + '&channel=' + channel;

                    let http = new XMLHttpRequest();
                    http.open('POST', url, true);
                    http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

                    http.onreadystatechange = function () {
                        if (http.readyState === 4 && http.status === 200) {
                            console.log(http.responseText);
                            webrtc.setRemoteDescription(new RTCSessionDescription({
                                type: 'answer',
                                sdp: atob(http.responseText)
                            }));
                        } else {
                            console.warn(http.status)
                        }
                    }

                    http.send('data=' + btoa(webrtc.localDescription.sdp));

                    break;
                case 'stable':


                    break;

                case 'closed':


                    break;

                default:
                    console.log(`unhandled signalingState is ${webrtc.signalingState}`);
                    break;
            }
        }

        async function handleNegotiationNeeded() {

            const uuid = '27aec28e-6181-4753-9acd-0456a75f0289'
            let channel = parseInt(document.getElementById("video-channel").innerText);

            let url = "/stream/" + uuid + "/channel/" + channel + "/webrtc?uuid=" + uuid + '&channel=' + channel;
            let offer = await webrtc.createOffer();

            await webrtc.setLocalDescription(offer);

            let http = new XMLHttpRequest();
            http.open('POST', url, true);
            http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

            http.onreadystatechange = function () {
                if (http.readyState === 4 && http.status === 200) {
                    console.log(http.responseText);
                    webrtc.setRemoteDescription(new RTCSessionDescription({
                        type: 'answer',
                        sdp: atob(http.responseText)
                    }));
                } else {
                    console.warn(http.status)
                }
            }

            http.send('data=' + btoa(webrtc.localDescription.sdp));
        }

        document.querySelector('#videoPlayer').addEventListener('error', () => {
            console.log('video_error')
        });
    </script>

    <script>
        let websocket;

        const keys = ['w', 'a', 's', 'd'];
        const pressedKeys = new Set();

        function connect() {
            websocket = new WebSocket("ws://localhost:8888");
            websocket.onopen = function (event) {
                console.log(event);
                checkPressedKeys();
                speedUpdate(document.getElementById("speed").value);
                channelUpdate(document.getElementById("channel").value);
            };

            websocket.onclose = function (event) {
                console.log("Socket closed. Attempt reconnect.", event.reason);
                setTimeout(function () {
                    connect();
                }, 1000);
            };

            websocket.onerror = function (err) {
                console.error("Websocket error", err);
                websocket.close();
            }

            document.addEventListener('keydown', function (event) {
                keys.forEach(function (key) {
                        if (key === event.key) {
                            pressedKeys.add(key);
                        }
                    }
                )
                checkPressedKeys();
            });

            document.addEventListener('keyup', function (event) {
                keys.forEach(function (key) {
                        if (key === event.key) {
                            pressedKeys.delete(key);
                        }
                    }
                )
                checkPressedKeys();
            });

        }


        function speedUpdate(speed) {
            const event = {type: "speed", speed: parseInt(speed)};
            websocket.send(JSON.stringify(event));
        }

        function channelUpdate(channel) {
            const event = {type: "channel", channel: parseInt(channel)};
            websocket.send(JSON.stringify(event));
        }

        function checkPressedKeys() {
            const [key] = pressedKeys;
            if (key) {
                sendKey(key);
            } else {
                sendKey('no_key');
            }
        }

        function sendKey(key) {
            const event = {type: "keyPress", key: key};
            websocket.send(JSON.stringify(event));
        }

        connect();

    </script>
</body>
</html>
