<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WebRTC</title>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
    </style>
</head>
<body>
    <p>Use wasd for control</p>
    <label for="speed">Speed of Carlos(10-100):</label>
    <input type="number" id="speed" step="10" onchange="speedUpdate(this.value)" name="speed" value="100" min="10"
           max="100">

    <label for="channel">Select channel:</label>
    <input type="number" id="channel" step="1" onchange="channelUpdate(this.value)" name="channel" value="0" min="0"
           max="3">

    <script>
        let websocket;

        const keys = ['w', 'a', 's', 'd'];
        const pressedKeys = new Set();

        function connect() {
            websocket = new WebSocket("ws://localhost:8888");
            websocket.onopen = function (event) {
                checkPressedKeys();
                speedUpdate(document.getElementById("speed").value);
                channelUpdate(document.getElementById("channel").value);
            };

            websocket.onclose = function (event) {
                console.log("Socket closed. Attempt reconnect.", event.reason);
                setTimeout(function () {
                    connect();
                }, 1000);
            };

            websocket.onerror = function (err) {
                console.error("Websocket error", err);
                websocket.close();
            }

            document.addEventListener('keydown', function (event) {
                keys.forEach(function (key) {
                        if (key === event.key) {
                            pressedKeys.add(key);
                        }
                    }
                )
                checkPressedKeys();
            });

            document.addEventListener('keyup', function (event) {
                keys.forEach(function (key) {
                        if (key === event.key) {
                            pressedKeys.delete(key);
                        }
                    }
                )
                checkPressedKeys();
            });

        }


        function speedUpdate(speed) {
            const event = {type: "speed", speed: parseInt(speed)};
            websocket.send(JSON.stringify(event));
        }

        function channelUpdate(channel) {
            const event = {type: "channel", channel: parseInt(channel)};
            websocket.send(JSON.stringify(event));
        }

        function checkPressedKeys() {
            const [key] = pressedKeys;
            if (key) {
                sendKey(key);
            } else {
                sendKey('no_key');
            }
        }

        function sendKey(key) {
            const event = {type: "keyPress", key: key};
            websocket.send(JSON.stringify(event));
        }

        connect();

    </script>
</body>
</html>
