<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WebRTC</title>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        .video-size {
            width: 640px;
            height: 480px;
            max-width: 50%;
            display: block;
            margin: 0 auto;
            transform: rotate(180deg);
        }

        .flex-center {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>
    <video id="videoPlayer" class="video-size" autoplay muted playsinline></video>
    <br>
    <div class="flex-center">
        <a href="#" id="left">&#8592;</a>
        <p id="current-channel"></p>
        <a href="#" id="right">&#8594;</a>
    </div>
    <script>let streams = {
        "27aec28e-6181-4753-9acd-0456a75f0289": {
            "name": "111111111",
            "channels": {
                "0": {"url": "rtsp://192.168.137.142:8554/cam", "on_demand": true},
                "1": {"url": "rtmp://171.25.232.10/12d525bc9f014e209c1280bc0d46a87e", "status": 1}
            }
        }
    };
    </script>
    <script>
        let webrtc, webrtcSendChannel;
        let mediaStream;

        document.addEventListener("DOMContentLoaded", function () {
            startPlay();
        });

        async function startPlay() {
            mediaStream = new MediaStream();
            document.querySelector('#videoPlayer').srcObject = mediaStream;
            webrtc = new RTCPeerConnection({
                iceServers: [{
                    urls: ["stun:stun.l.google.com:19302"]
                }],
                sdpSemantics: "unified-plan"
            });
            webrtc.onnegotiationneeded = handleNegotiationNeeded;
            webrtc.onsignalingstatechange = signalingstatechange;

            webrtc.ontrack = ontrack
            let offer = await webrtc.createOffer({

                offerToReceiveAudio: true,
                offerToReceiveVideo: true
            });
            await webrtc.setLocalDescription(offer);
        }

        function ontrack(event) {
            console.log(event.streams.length + ' track is delivered');
            mediaStream.addTrack(event.track);
        }

        async function signalingstatechange() {
            switch (webrtc.signalingState) {
                case 'have-local-offer':
                    const schema = 'http'
                    const server = 'localhost'
                    const port = '8083'
                    const uuid = '27aec28e-6181-4753-9acd-0456a75f0289'
                    const maxChannel = 10;

                    let channel;

                    if (window.location.hash) {
                        channel = window.location.hash.replace(/\D/g, '');
                    } else {
                        channel = 0;
                    }

                    // Set channel switch button
                    window.document.getElementById("left").href = "#" + Math.max(0, channel - 1);
                    window.document.getElementById("right").href = "#" + Math.min(maxChannel, channel - (-1));
                    window.document.getElementById("current-channel").innerText = "Current channel: " + channel;

                    addEventListener('hashchange', function () {
                        window.location.reload();
                    });


                    let url = schema + '://' + server + ':' + port + '/stream/' + uuid + '/channel/' + channel + '/webrtc?uuid=' + uuid + '&channel=' + channel;

                    let http = new XMLHttpRequest();
                    http.open('POST', url, true);
                    http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

                    http.onreadystatechange = function () {
                        if (http.readyState === 4 && http.status === 200) {
                            console.log(http.responseText);
                            webrtc.setRemoteDescription(new RTCSessionDescription({
                                type: 'answer',
                                sdp: atob(http.responseText)
                            }));
                        } else {
                            console.warn(http.status)
                        }
                    }

                    http.send('data=' + btoa(webrtc.localDescription.sdp));

                    break;
                case 'stable':


                    break;

                case 'closed':


                    break;

                default:
                    console.log(`unhandled signalingState is ${webrtc.signalingState}`);
                    break;
            }
        }

        async function handleNegotiationNeeded() {

            const uuid = '27aec28e-6181-4753-9acd-0456a75f0289'
            let channel;

            if (window.location.hash) {
                channel = window.location.hash.replace(/\D/g, '');
            } else {
                channel = 0;
            }
            let url = "/stream/" + uuid + "/channel/" + channel + "/webrtc?uuid=" + uuid + '&channel=' + channel;
            let offer = await webrtc.createOffer();

            await webrtc.setLocalDescription(offer);

            let http = new XMLHttpRequest();
            http.open('POST', url, true);
            http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

            http.onreadystatechange = function () {
                if (http.readyState === 4 && http.status === 200) {
                    console.log(http.responseText);
                    webrtc.setRemoteDescription(new RTCSessionDescription({
                        type: 'answer',
                        sdp: atob(http.responseText)
                    }));
                } else {
                    console.warn(http.status)
                }
            }

            http.send('data=' + btoa(webrtc.localDescription.sdp));
        }

        document.querySelector('#videoPlayer').addEventListener('error', () => {
            console.log('video_error')
        });
    </script>
</body>
</html>
